#labels 
#summary IMAP Implementation Notes

= Introduction =

This page is a place to keep track of implementation ideas and shortcomings of the ErlMail IMAP Server. Most of these have been generated from reading RFC2683 IMAP Implementation Recommendations.

== Response Server ==

The response server will be responsible for accepting responses, both tagged and untagged, 

There seems to be a need to create a Response Server based on the gen_server behavior. This server would keep track of the response queue for each client that may be connected. As a client connects to the IMAP server it will register itself with the response server, using the FSM PID as the connection ID. 

Certain commands will change information about the connection to the response server; LOGIN will inform the response server which user the client is interested in, SELECT, EXAMINE and CLOSE will inform the response server which mailbox the client is currently working with.

As events happen that change the mailbox a message queue will collect all responses and hold them until the client issues a command that will allow for the correct responses to be released.

The response server will need ways to insert, update, delete and select responses to be stored in the queue. It will also need a way to select untagged, tagged or all responses.

The response server will need a way to make sure that the information is distributed and fault tolerant. The response queue will be kept in RAM only mnesia tables that will be created as needed and only kept so long as the response servers are running. The will need to be of type 'bag' to allow for multiple response with the same key. This will eventual need some optimization on large isntalls limting the Mnesia tables to only a few servers and mkaing a way to move the Mnesia talbes to servers that have the most resourses, i.e. ram.

== Mailbox Server ==

When a mailbox is placed into a selected state then client would in effect join the queue for each response that is generated by the system and the responses that are created by commands from that client.

In the scenario where to clients are connected and have the same mailbox selected; one of the clients can use the FETCH command to view the message. This will in most cases generate a change in status to for the message and set a flag for SEEN. The client that has issues the FETCH command needs to be able to get both the change in status and the information from the FETCH command, while the second client needs only to see that the message status has changed and the SEEN flag has been set.

Some consideration needs to be taken into account to minimize message that would be contradictory, although that may be an optimization issue for later version. This would needed in the instance that a message is sent a sequence of commands that are duplicated or revert the message to the original state. If a message is set to FLAGGED, then UNFLAGGED and finally FLAGGED again, the first FLAGGED and UNFLAGGED responses are not needed, only the final FLAGGED response should be sent.
